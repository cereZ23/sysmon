name: Sysmon Detection Testing

on:
  push:
    paths:
      - 'sysmon/*.xml'
      - 'sysmon/tests/**'
      - '.github/workflows/sysmon-test.yml'
  pull_request:
    paths:
      - 'sysmon/*.xml'
  workflow_dispatch:
    inputs:
      config_type:
        description: 'Config to test (ws, srv, dc, sql, exch, iis, all)'
        required: true
        default: 'all'

jobs:
  validate-xml:
    name: Validate XML Syntax
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install xmllint
        run: sudo apt-get update && sudo apt-get install -y libxml2-utils

      - name: Validate Sysmon XML files
        run: |
          echo "Validating Sysmon configuration XML syntax..."
          if ls sysmon/sysmon-*.xml 1> /dev/null 2>&1; then
            for file in sysmon/sysmon-*.xml; do
              echo "Checking $file..."
              xmllint --noout "$file" && echo "  ✓ Valid XML" || exit 1
            done
            echo "All XML files are valid!"
          else
            echo "No XML files found in sysmon/ directory"
            ls -la sysmon/ || echo "sysmon directory not found"
            exit 1
          fi

  test-sysmon-configs:
    name: Test ${{ matrix.config }} Config
    needs: validate-xml
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        config: [ws, srv, dc, sql, exch, iis]

    steps:
      - uses: actions/checkout@v4

      - name: Download Sysmon
        shell: powershell
        run: |
          Write-Host "Downloading Sysmon from Sysinternals..."
          $ProgressPreference = 'SilentlyContinue'
          Invoke-WebRequest -Uri "https://download.sysinternals.com/files/Sysmon.zip" -OutFile "Sysmon.zip"
          Expand-Archive -Path "Sysmon.zip" -DestinationPath ".\Sysmon" -Force
          Write-Host "Sysmon downloaded successfully"

      - name: Install Sysmon with ${{ matrix.config }} config
        shell: powershell
        run: |
          $configFile = "sysmon\sysmon-${{ matrix.config }}.xml"
          Write-Host "Installing Sysmon with config: $configFile"

          # Install Sysmon - ignore stderr as Sysmon writes info there
          $ErrorActionPreference = 'SilentlyContinue'
          & .\Sysmon\Sysmon64.exe -accepteula -i $configFile *>&1 | Write-Host
          $ErrorActionPreference = 'Continue'

          # Wait for service to start
          Start-Sleep -Seconds 5

          # Verify installation - this is what matters
          $service = Get-Service -Name Sysmon64 -ErrorAction SilentlyContinue
          if ($service -and $service.Status -eq 'Running') {
            Write-Host '[OK] Sysmon installed and running' -ForegroundColor Green
            exit 0
          } else {
            Write-Host '[FAIL] Sysmon installation failed' -ForegroundColor Red
            exit 1
          }

      - name: Run Detection Tests
        id: detection_test
        shell: powershell
        run: |
          Write-Host "Running detection tests for ${{ matrix.config }} configuration..."
          Write-Host "=" * 60

          # Source the test functions
          . .\sysmon\tests\Test-SysmonDetection.ps1 -ConfigType "${{ matrix.config }}" -CI

        continue-on-error: true

      - name: Collect Sysmon Events
        if: always()
        shell: powershell
        run: |
          Write-Host "Collecting Sysmon events generated during tests..."

          $events = Get-WinEvent -LogName "Microsoft-Windows-Sysmon/Operational" -MaxEvents 500 -ErrorAction SilentlyContinue

          if ($events) {
            Write-Host "Total events captured: $($events.Count)"
            Write-Host ""

            # Summary by Event ID
            Write-Host "Events by Type:"
            Write-Host "-" * 40
            $events | Group-Object Id | Sort-Object Name | ForEach-Object {
              $eventName = switch ($_.Name) {
                1  { "ProcessCreate" }
                2  { "FileCreateTime" }
                3  { "NetworkConnect" }
                5  { "ProcessTerminate" }
                6  { "DriverLoad" }
                7  { "ImageLoad" }
                8  { "CreateRemoteThread" }
                9  { "RawAccessRead" }
                10 { "ProcessAccess" }
                11 { "FileCreate" }
                12 { "RegistryAddDelete" }
                13 { "RegistryValueSet" }
                14 { "RegistryRename" }
                15 { "FileCreateStreamHash" }
                17 { "PipeCreated" }
                18 { "PipeConnected" }
                19 { "WmiFilterCreate" }
                20 { "WmiConsumerCreate" }
                21 { "WmiBindingCreate" }
                22 { "DnsQuery" }
                23 { "FileDelete" }
                24 { "ClipboardChange" }
                25 { "ProcessTampering" }
                26 { "FileDeleteDetected" }
                default { "Unknown" }
              }
              Write-Host ("  Event {0,2} ({1,-20}): {2}" -f $_.Name, $eventName, $_.Count)
            }

            # Export to artifact
            $events | Select-Object TimeCreated, Id, Message |
              Export-Csv -Path "sysmon-events-${{ matrix.config }}.csv" -NoTypeInformation

          } else {
            Write-Host "No Sysmon events captured - config may be too restrictive"
          }

      - name: Upload Event Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sysmon-events-${{ matrix.config }}
          path: sysmon-events-${{ matrix.config }}.csv
          if-no-files-found: ignore

      - name: Uninstall Sysmon
        if: always()
        shell: powershell
        run: |
          Write-Host 'Cleaning up Sysmon...'
          $svc = Get-Service -Name Sysmon64 -ErrorAction SilentlyContinue
          if ($svc) {
            $ErrorActionPreference = 'SilentlyContinue'
            & .\Sysmon\Sysmon64.exe -u force *>&1 | Out-Null
            Write-Host 'Sysmon uninstalled'
          } else {
            Write-Host 'Sysmon was not installed, skipping cleanup'
          }
          exit 0

  atomic-red-team:
    name: Atomic Red Team - ${{ matrix.config }}
    needs: validate-xml
    runs-on: windows-latest
    if: github.event_name == 'workflow_dispatch'
    strategy:
      fail-fast: false
      matrix:
        config: [ws, srv, dc, sql, exch, iis]

    steps:
      - uses: actions/checkout@v4

      - name: Download Sysmon
        shell: powershell
        run: |
          $ProgressPreference = 'SilentlyContinue'
          Invoke-WebRequest -Uri "https://download.sysinternals.com/files/Sysmon.zip" -OutFile "Sysmon.zip"
          Expand-Archive -Path "Sysmon.zip" -DestinationPath ".\Sysmon" -Force

      - name: Install Sysmon
        shell: powershell
        run: |
          $ErrorActionPreference = 'SilentlyContinue'
          & .\Sysmon\Sysmon64.exe -accepteula -i "sysmon\sysmon-${{ matrix.config }}.xml" *>&1 | Write-Host
          Start-Sleep -Seconds 5
          $service = Get-Service -Name Sysmon64 -ErrorAction SilentlyContinue
          if ($service -and $service.Status -eq 'Running') {
            Write-Host '[OK] Sysmon installed'
            exit 0
          } else {
            Write-Host '[FAIL] Sysmon not running'
            exit 1
          }

      - name: Install Atomic Red Team
        shell: powershell
        run: |
          Write-Host "Installing Atomic Red Team..."
          IEX (IWR 'https://raw.githubusercontent.com/redcanaryco/invoke-atomicredteam/master/install-atomicredteam.ps1' -UseBasicParsing)
          Install-AtomicRedTeam -getAtomics -Force -ErrorAction SilentlyContinue
          Write-Host "Atomic Red Team installed"

      - name: Run Atomic Tests with Detection Matching
        shell: powershell
        run: |
          Write-Host "Running Atomic Red Team tests with detection matching..."
          Write-Host "Configuration: ${{ matrix.config }}"
          Write-Host ""

          # Import module
          Import-Module "C:\AtomicRedTeam\invoke-atomicredteam\Invoke-AtomicRedTeam.psd1" -Force

          # COMPREHENSIVE technique list - covers major MITRE ATT&CK categories
          # These are "safe" techniques that work on GitHub runners
          $allTechniques = @(
            # === EXECUTION (T1059) ===
            "T1059.001",  # PowerShell
            "T1059.003",  # Windows Command Shell
            "T1059.005",  # Visual Basic
            "T1059.006",  # Python
            "T1059.007",  # JavaScript
            "T1047",      # WMI
            "T1106",      # Native API
            "T1129",      # Shared Modules
            "T1204.002",  # Malicious File

            # === PERSISTENCE (T1547, T1053, T1543) ===
            "T1547.001",  # Registry Run Keys
            "T1547.004",  # Winlogon Helper DLL
            "T1547.005",  # Security Support Provider
            "T1547.009",  # Shortcut Modification
            "T1053.005",  # Scheduled Task
            "T1543.003",  # Windows Service
            "T1546.001",  # Change Default File Association
            "T1546.003",  # WMI Event Subscription
            "T1546.008",  # Accessibility Features
            "T1546.011",  # Application Shimming
            "T1546.015",  # COM Hijacking
            "T1197",      # BITS Jobs
            "T1136.001",  # Local Account

            # === PRIVILEGE ESCALATION ===
            "T1548.002",  # Bypass UAC
            "T1134.001",  # Token Impersonation
            "T1134.002",  # Create Process with Token

            # === DEFENSE EVASION (T1218, T1027, T1070) ===
            "T1218.001",  # Compiled HTML File
            "T1218.003",  # CMSTP
            "T1218.004",  # InstallUtil
            "T1218.005",  # Mshta
            "T1218.007",  # Msiexec
            "T1218.008",  # Odbcconf
            "T1218.009",  # Regasm/Regsvcs
            "T1218.010",  # Regsvr32
            "T1218.011",  # Rundll32
            "T1027",      # Obfuscated Files
            "T1027.004",  # Compile After Delivery
            "T1140",      # Deobfuscate/Decode
            "T1036.003",  # Rename System Utilities
            "T1036.005",  # Match Legitimate Name
            "T1070.001",  # Clear Windows Event Logs
            "T1070.003",  # Clear Command History
            "T1070.004",  # File Deletion
            "T1070.006",  # Timestomp
            "T1562.001",  # Disable Security Tools
            "T1562.004",  # Disable Windows Firewall
            "T1112",      # Modify Registry
            "T1222.001",  # Windows File Permissions
            "T1564.001",  # Hidden Files
            "T1564.003",  # Hidden Window
            "T1564.004",  # NTFS File Attributes

            # === CREDENTIAL ACCESS (T1003, T1558, T1552) ===
            "T1003.001",  # LSASS Memory
            "T1003.002",  # SAM
            "T1003.003",  # NTDS
            "T1003.004",  # LSA Secrets
            "T1003.005",  # Cached Credentials
            "T1558.003",  # Kerberoasting
            "T1552.001",  # Credentials in Files
            "T1552.002",  # Credentials in Registry
            "T1552.004",  # Private Keys
            "T1552.006",  # GPP Passwords
            "T1555.003",  # Credentials from Web Browsers
            "T1056.001",  # Keylogging
            "T1040",      # Network Sniffing
            "T1110.001",  # Password Guessing
            "T1110.003",  # Password Spraying

            # === DISCOVERY (T1087, T1082, T1057) ===
            "T1087.001",  # Local Account
            "T1087.002",  # Domain Account
            "T1082",      # System Information
            "T1057",      # Process Discovery
            "T1018",      # Remote System Discovery
            "T1016",      # System Network Config
            "T1049",      # System Network Connections
            "T1033",      # System Owner/User
            "T1007",      # System Service Discovery
            "T1069.001",  # Local Groups
            "T1069.002",  # Domain Groups
            "T1482",      # Domain Trust Discovery
            "T1083",      # File and Directory Discovery
            "T1135",      # Network Share Discovery
            "T1120",      # Peripheral Device Discovery
            "T1012",      # Query Registry
            "T1518.001",  # Security Software Discovery
            "T1124",      # System Time Discovery
            "T1201",      # Password Policy Discovery

            # === LATERAL MOVEMENT ===
            "T1021.001",  # Remote Desktop
            "T1021.002",  # SMB/Windows Admin Shares
            "T1021.003",  # DCOM
            "T1021.006",  # Windows Remote Management
            "T1570",      # Lateral Tool Transfer

            # === COLLECTION ===
            "T1560.001",  # Archive via Utility
            "T1113",      # Screen Capture
            "T1115",      # Clipboard Data
            "T1119",      # Automated Collection
            "T1005",      # Data from Local System
            "T1039",      # Data from Network Shared Drive
            "T1074.001",  # Local Data Staging

            # === COMMAND AND CONTROL ===
            "T1071.001",  # Web Protocols
            "T1105",      # Ingress Tool Transfer
            "T1132.001",  # Standard Encoding
            "T1572",      # Protocol Tunneling
            "T1090.001",  # Internal Proxy

            # === IMPACT ===
            "T1489",      # Service Stop
            "T1529",      # System Shutdown/Reboot
            "T1491.001"   # Internal Defacement
          )

          # All configs test the same comprehensive set of ~90 techniques
          $techniques = $allTechniques
          $config = "${{ matrix.config }}"

          Write-Host "Testing $($techniques.Count) MITRE ATT&CK techniques for $config configuration"
          Write-Host "=" * 60

          $results = @()

          foreach ($technique in $techniques) {
            Write-Host "`n[*] Testing $technique..." -ForegroundColor Cyan

            # Record start time
            $startTime = Get-Date

            # Get events before test
            $eventsBefore = (Get-WinEvent -LogName "Microsoft-Windows-Sysmon/Operational" -MaxEvents 5000 -ErrorAction SilentlyContinue).Count

            try {
              # Execute atomic test
              $ErrorActionPreference = 'SilentlyContinue'
              Invoke-AtomicTest -AtomicTechnique $technique -ErrorAction SilentlyContinue *>&1 | Out-Null

              # Wait for Sysmon to process
              Start-Sleep -Seconds 3

              # Get events after test
              $eventsAfter = Get-WinEvent -LogName "Microsoft-Windows-Sysmon/Operational" -MaxEvents 5000 -ErrorAction SilentlyContinue
              $newEvents = $eventsAfter | Where-Object { $_.TimeCreated -ge $startTime }
              $eventCount = $newEvents.Count

              # Get event types generated
              $eventTypes = ($newEvents | Group-Object Id | ForEach-Object { $_.Name }) -join ","

              $detected = $eventCount -gt 0
              $status = if ($detected) { "DETECTED" } else { "NOT_DETECTED" }

              Write-Host "    Events generated: $eventCount [$eventTypes]" -ForegroundColor $(if($detected){'Green'}else{'Yellow'})

              $results += [PSCustomObject]@{
                Technique = $technique
                Config = $config
                Status = $status
                EventCount = $eventCount
                EventTypes = $eventTypes
                Timestamp = $startTime.ToString("yyyy-MM-dd HH:mm:ss")
              }

              # Cleanup after each test
              Invoke-AtomicTest -AtomicTechnique $technique -Cleanup -ErrorAction SilentlyContinue *>&1 | Out-Null
            }
            catch {
              Write-Host "    Error: $($_.Exception.Message)" -ForegroundColor Red
              $results += [PSCustomObject]@{
                Technique = $technique
                Config = $config
                Status = "ERROR"
                EventCount = 0
                EventTypes = ""
                Timestamp = $startTime.ToString("yyyy-MM-dd HH:mm:ss")
              }
            }
          }

          # Summary
          Write-Host "`n" + "=" * 60
          Write-Host "DETECTION COVERAGE SUMMARY - $config"
          Write-Host "=" * 60

          $detected = ($results | Where-Object { $_.Status -eq "DETECTED" }).Count
          $notDetected = ($results | Where-Object { $_.Status -eq "NOT_DETECTED" }).Count
          $errors = ($results | Where-Object { $_.Status -eq "ERROR" }).Count
          $total = $results.Count
          $rate = if ($total -gt 0) { [math]::Round(($detected / $total) * 100, 1) } else { 0 }

          Write-Host "Techniques Tested: $total"
          Write-Host "Detected: $detected" -ForegroundColor Green
          Write-Host "Not Detected: $notDetected" -ForegroundColor Yellow
          Write-Host "Errors: $errors" -ForegroundColor Red
          Write-Host "Detection Rate: $rate%" -ForegroundColor Cyan

          # Export detailed results
          $results | Export-Csv -Path "detection-coverage-${{ matrix.config }}.csv" -NoTypeInformation

          # Create markdown summary
          $mdContent = @"
          # Detection Coverage Report - $config

          **Date:** $(Get-Date -Format "yyyy-MM-dd HH:mm:ss")
          **Configuration:** $config
          **Detection Rate:** $rate%

          ## Summary
          | Metric | Count |
          |--------|-------|
          | Techniques Tested | $total |
          | Detected | $detected |
          | Not Detected | $notDetected |
          | Errors | $errors |

          ## Detailed Results
          | Technique | Status | Events | Event Types |
          |-----------|--------|--------|-------------|
          "@

          foreach ($r in $results) {
            $mdContent += "`n| $($r.Technique) | $($r.Status) | $($r.EventCount) | $($r.EventTypes) |"
          }

          $mdContent | Out-File -FilePath "detection-report-${{ matrix.config }}.md" -Encoding UTF8

      - name: Collect Detection Results
        if: always()
        shell: powershell
        run: |
          $events = Get-WinEvent -LogName "Microsoft-Windows-Sysmon/Operational" -MaxEvents 1000 -ErrorAction SilentlyContinue

          Write-Host "Events captured: $($events.Count)"
          Write-Host ""

          $events | Group-Object Id | Sort-Object Count -Descending | ForEach-Object {
            Write-Host "  Event $($_.Name): $($_.Count)"
          }

          $events | Select-Object TimeCreated, Id, Message |
            Export-Csv -Path "atomic-events-${{ matrix.config }}.csv" -NoTypeInformation

      - name: Upload Detection Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: detection-results-${{ matrix.config }}
          path: |
            detection-coverage-${{ matrix.config }}.csv
            detection-report-${{ matrix.config }}.md
            atomic-events-${{ matrix.config }}.csv
          if-no-files-found: ignore

      - name: Cleanup
        if: always()
        shell: powershell
        run: |
          $svc = Get-Service -Name Sysmon64 -ErrorAction SilentlyContinue
          if ($svc) {
            $ErrorActionPreference = 'SilentlyContinue'
            & .\Sysmon\Sysmon64.exe -u force *>&1 | Out-Null
          }
          exit 0

  summary:
    name: Test Summary
    needs: [test-sysmon-configs]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: results
          pattern: sysmon-events-*
          merge-multiple: true
        continue-on-error: true

      - name: Generate Summary
        run: |
          echo "# Sysmon Detection Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Configuration Test Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Config | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ws | ${{ needs.test-sysmon-configs.result == 'success' && '✅ Passed' || '⚠️ Check logs' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| srv | ${{ needs.test-sysmon-configs.result == 'success' && '✅ Passed' || '⚠️ Check logs' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| dc | ${{ needs.test-sysmon-configs.result == 'success' && '✅ Passed' || '⚠️ Check logs' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| sql | ${{ needs.test-sysmon-configs.result == 'success' && '✅ Passed' || '⚠️ Check logs' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| exch | ${{ needs.test-sysmon-configs.result == 'success' && '✅ Passed' || '⚠️ Check logs' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| iis | ${{ needs.test-sysmon-configs.result == 'success' && '✅ Passed' || '⚠️ Check logs' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "Event logs from each configuration are available in the workflow artifacts." >> $GITHUB_STEP_SUMMARY
